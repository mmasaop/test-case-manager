# サブスクリプション登録 - プラン変更テスト

## テスト概要
無料プランから有料プランへのアップグレードが正常に処理されることを確認する

## 前提条件
- 無料プランのアカウントでログイン済み
- クレジットカード情報が未登録
- 現在の利用状況が表示されている

## テストシナリオ

### 1. 料金プランページの確認

プラン一覧ページにアクセスし、以下の3つのプランが表示されることを確認：

<PricingTable>
  <Plan name="Free" price="¥0/月">
    - 5GBストレージ
    - 基本機能のみ
    - メールサポート
  </Plan>
  
  <Plan name="Pro" price="¥1,980/月" recommended>
    - 100GBストレージ
    - 全機能利用可能
    - 優先サポート
    - API利用可能
  </Plan>
  
  <Plan name="Business" price="¥9,800/月">
    - 無制限ストレージ
    - 全機能利用可能
    - 専任サポート
    - SLA保証
  </Plan>
</PricingTable>

### 2. プランの選択

1. **Proプランを選択**
   - 「Proプランにアップグレード」ボタンをクリック
   - 支払い情報入力画面へ遷移

2. **現在の利用状況の確認**
   ```
   現在のプラン: Free
   次回請求日: -
   利用中のストレージ: 2.3GB / 5GB
   ```

### 3. 支払い情報の入力

クレジットカード情報を入力：

![支払い情報入力画面](./billing-info.png)

### 4. 確認と同意

- [ ] 利用規約に同意
- [ ] 自動更新について理解した
- [ ] 日割り計算の説明を確認

<BillingPreview>
  今月の請求額（日割り）: ¥990
  次回請求日: 2024年2月1日
  請求額: ¥1,980
</BillingPreview>

### 5. アップグレードの実行

1. 「プランをアップグレード」ボタンをクリック
2. 処理中のローディング表示を確認
3. 完了通知の表示

## 期待される結果

- ✅ アカウントがProプランに即座に切り替わる
- ✅ 利用可能なストレージが100GBに増加
- ✅ Pro限定機能が利用可能になる
- ✅ 確認メールが送信される
- ✅ 請求履歴に取引が記録される

## 検証ポイント

### 機能面
- [ ] プラン変更が即座に反映される
- [ ] 新機能へのアクセスが可能
- [ ] ストレージ容量が更新される

### 課金面
- [ ] 初回は日割り計算される
- [ ] 次回請求日が正しく設定される
- [ ] 請求書がダウンロード可能

### エラーハンドリング
- [ ] カード決済失敗時の適切なエラー表示
- [ ] ネットワークエラー時のリトライ
- [ ] 二重課金の防止

## 実行結果
<TestResult status="not-executed" />

## テストデータ

```javascript
// Webhookイベントの確認
const expectedWebhook = {
  event: "customer.subscription.created",
  customerId: "cus_test123",
  subscriptionId: "sub_test456",
  planId: "pro_monthly",
  status: "active"
}
```

## ダウングレードのテスト

プランのダウングレード時は以下を確認：
- 現在の請求期間終了まで機能が利用可能
- 自動更新がキャンセルされる
- データの保持期間の通知

## 備考
- プラン変更は月に1回まで可能
- 年間プランへの変更は別途テストケースを参照
- キャンセル時の返金ポリシーを確認すること

## 関連テストケース
- [サブスクリプションキャンセルテスト](../0002/case.mdx)
- [年間プランへの変更テスト](../0003/case.mdx)
- [支払い失敗時の猶予期間テスト](../0004/case.mdx)