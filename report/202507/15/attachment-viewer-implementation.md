# 添付ファイルビューアー機能実装報告書

作成日: 2025年7月15日

## 作業内容の詳細説明

### 実装背景
ユーザーからの要望により、テストケース管理システムにおける添付ファイルの扱いを大幅に改善しました。

### 実装した機能

#### 1. case.mdxファイルの完全非表示化
- 検索時を含め、すべての状況でcase.mdxファイルを非表示に変更
- フォルダ名（番号付きフォルダ）をクリックすることで開く仕様を維持
- ファイルツリーの見た目をよりシンプルに

#### 2. 添付ファイル表示の改善
- 各フォルダ内のすべての添付ファイルを個別に表示
- ファイルタイプに応じた適切なアイコン表示
  - 画像ファイル：Imageアイコン
  - アーカイブファイル：FileArchiveアイコン
  - その他：汎用Fileアイコン
- MDXファイル以外のすべてのファイルを添付ファイルとして扱う

#### 3. AttachmentViewerコンポーネントの新規実装
- 添付ファイルを右側のエリアで表示する専用コンポーネント
- ファイルタイプに応じた表示方法：
  - **画像ファイル**：プレビュー表示（最大サイズに収まるように自動調整）
  - **テキストファイル**：内容をそのまま表示
  - **アーカイブファイル**：ダウンロード促進UI
  - **その他**：サポート外メッセージとダウンロードボタン

#### 4. ファイルダウンロード機能
- すべてのファイルタイプでダウンロード可能
- File System Access APIを使用した安全なファイル取得
- ブラウザ標準のダウンロード機能を利用

## 修正・変更に関する重要ポイント

### 1. ファイルシステムの変更
```typescript
// fileSystem.ts の変更点
- 画像ファイルのみを検出 → すべての非MDXファイルを検出
- imageFiles プロパティを汎用的な添付ファイル格納に使用
- 隠しファイルとcase.mdxは除外
```

### 2. UIコンポーネントの追加
- `button.tsx`：汎用ボタンコンポーネント（shadcn/ui風）
- バリアント（default, outline, destructive等）とサイズ対応

### 3. アプリケーションフローの変更
```typescript
// App.tsx の変更
- MDXファイルとそれ以外でコンポーネントを切り替え
- isAttachment フラグでファイルタイプを判定
```

## コードレビュー後の仕様と実装の注意点

### 仕様の明確化
1. **添付ファイルの定義**
   - MDXファイル以外のすべてのファイル
   - 隠しファイル（.で始まる）は除外
   - case.mdxは特別扱いで常に非表示

2. **プレビュー対応形式**
   - 画像：jpg, jpeg, png, gif, webp, svg
   - テキスト：txt, log, json, xml, csv, yaml, yml
   - アーカイブ：zip, rar, 7z, tar, gz

### 実装上の注意点
1. **メモリ管理**
   - 画像URLは`URL.createObjectURL`で生成
   - コンポーネントのアンマウント時に`URL.revokeObjectURL`で解放
   - 大きなファイルでもメモリリークを防ぐ

2. **エラーハンドリング**
   - ファイル読み込みエラーは適切にキャッチ
   - ユーザーフレンドリーなエラーメッセージ表示

3. **パフォーマンス**
   - ファイル読み込みは非同期で実行
   - ローディング状態を表示してUXを向上

## 実装における重要事項とテストの観点

### テスト観点

1. **ファイル表示テスト**
   - 各種ファイル形式が正しく認識されること
   - アイコンが適切に表示されること
   - case.mdxが表示されないこと

2. **プレビュー機能テスト**
   - 画像ファイルが正しくプレビューされること
   - 大きな画像が適切にリサイズされること
   - テキストファイルの内容が正しく表示されること
   - 日本語を含むテキストファイルの文字化けがないこと

3. **ダウンロード機能テスト**
   - すべてのファイルタイプでダウンロードが動作すること
   - ファイル名が保持されること
   - 大きなファイルでも正常に動作すること

4. **エラーケーステスト**
   - 読み込み権限がないファイルの処理
   - 破損したファイルの処理
   - ネットワークエラー時の挙動

### セキュリティ考慮事項
1. **XSS対策**
   - テキストファイルの内容は`<pre>`タグで表示（HTMLエスケープ）
   - 画像は`<img>`タグのsrc属性にObjectURLを設定

2. **ファイルアクセス制限**
   - File System Access APIの権限範囲内でのみ動作
   - ユーザーが選択したディレクトリ内のファイルのみアクセス可能

### 今後の改善提案

1. **プレビュー機能の拡張**
   - PDFファイルのプレビュー
   - Office文書のプレビュー（サードパーティライブラリ使用）
   - 動画・音声ファイルの再生機能

2. **編集機能**
   - テキストファイルの直接編集
   - 画像の簡単な編集（回転、クロップ）

3. **ファイル管理機能**
   - ファイルのアップロード
   - ファイルの削除・リネーム
   - ドラッグ&ドロップでのファイル移動

4. **検索機能の強化**
   - 添付ファイル名での検索
   - ファイルタイプでのフィルタリング

## まとめ

本実装により、テストケース管理システムの添付ファイル機能が大幅に向上しました。ユーザーは添付ファイルを簡単にプレビュー・ダウンロードできるようになり、テストケースの管理効率が向上すると期待されます。

特に画像ファイルのプレビュー機能は、スクリーンショットを多用するテストケースにおいて非常に有用です。また、すべてのファイルタイプでダウンロード機能を提供することで、柔軟なファイル管理が可能になりました。